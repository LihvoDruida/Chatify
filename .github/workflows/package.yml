name: Continuous Integration

on:
  push:
    tags:
      - "*"           # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚Ð¸ Ð½Ð° Ð±ÑƒÐ´ÑŒ-ÑÐºÐ¸Ð¹ Ñ‚ÐµÐ³
      - "!**-alpha**" # Ð†Ð³Ð½Ð¾Ñ€ÑƒÐ²Ð°Ñ‚Ð¸ Ñ‚ÐµÐ³Ð¸ Ð· ÑÑƒÑ„Ñ–ÐºÑÐ¾Ð¼ -alpha
      - "!**-beta**"  # Ð†Ð³Ð½Ð¾Ñ€ÑƒÐ²Ð°Ñ‚Ð¸ Ñ‚ÐµÐ³Ð¸ Ð· ÑÑƒÑ„Ñ–ÐºÑÐ¾Ð¼ -beta

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    outputs:
      changeLogText: ${{ steps.readChanglog.outputs.text }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Get Latest Tag or use TOC version
        id: get_latest_tag
        run: |
          # 1. Ð¨ÑƒÐºÐ°Ñ”Ð¼Ð¾ Ñ„Ð°Ð¹Ð» .toc (Ð±ÐµÑ€ÐµÐ¼Ð¾ Ð¿ÐµÑ€ÑˆÐ¸Ð¹ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¸Ð¹, Ñ‰Ð¾Ð± Ð½Ðµ Ñ…Ð°Ñ€Ð´ÐºÐ¾Ð´Ð¸Ñ‚Ð¸ Ð½Ð°Ð·Ð²Ñƒ)
          TOC_FILE=$(find . -maxdepth 1 -name "*.toc" | head -n 1)
          echo "ðŸ“‚ Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ TOC Ñ„Ð°Ð¹Ð»: $TOC_FILE"

          # 2. Ð’Ð¸Ñ‚ÑÐ³ÑƒÑ”Ð¼Ð¾ Ð²ÐµÑ€ÑÑ–ÑŽ Ð· TOC
          if [ -f "$TOC_FILE" ]; then
            TOC_VERSION=$(grep -oP '^## Version: \K.*' "$TOC_FILE" | tr -d '\r')
          else
            TOC_VERSION="1.0"
          fi
          
          TOC_FALLBACK="v${TOC_VERSION}"

          # 3. ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ Ñ‚ÐµÐ³Ð¸
          TAGS=$(git tag -l)
          if [ -z "$TAGS" ]; then
            LATEST_TAG="$TOC_FALLBACK"
            echo "âš ï¸ Ð¢ÐµÐ³Ð¸ Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾, Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ñ‚ÑŒÑÑ Ð²ÐµÑ€ÑÑ–Ñ Ð· TOC: $LATEST_TAG"
          else
            LATEST_TAG=$(git describe --tags --abbrev=0)
            echo "ðŸ§· Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð¾ÑÑ‚Ð°Ð½Ð½Ñ–Ð¹ Ñ‚ÐµÐ³: $LATEST_TAG"
          fi

          # 4. Ð—Ð±ÐµÑ€Ñ–Ð³Ð°Ñ”Ð¼Ð¾ Ð·Ð¼Ñ–Ð½Ð½Ñ–
          echo "FINAL_VERSION=$LATEST_TAG" >> $GITHUB_ENV
          echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Print Debug Info
        run: |
          echo "GitHub Ref: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
          echo "Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð°Ð½Ð° Ð²ÐµÑ€ÑÑ–Ñ: $FINAL_VERSION"

      - name: Update Version in .toc Files
        run: |
          # ÐžÐ½Ð¾Ð²Ð»ÑŽÑ” Ð¿Ð¾Ð»Ðµ Version Ñƒ Ð²ÑÑ–Ñ… .toc Ñ„Ð°Ð¹Ð»Ð°Ñ… Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ñ–ÑŽ Ð½Ð° Ð¿Ð¾Ñ‚Ð¾Ñ‡Ð½Ð¸Ð¹ Ñ‚ÐµÐ³
          # Ð’Ð¸Ð´Ð°Ð»ÑÑ” Ð»Ñ–Ñ‚ÐµÑ€Ñƒ 'v' ÑÐºÑ‰Ð¾ Ð²Ð¾Ð½Ð° Ñ” (Ð½Ð°Ð¿Ñ€Ð¸ÐºÐ»Ð°Ð´ v1.2 -> 1.2), Ð±Ð¾ WoW Ð»ÑŽÐ±Ð¸Ñ‚ÑŒ Ñ‡Ð¸ÑÑ‚Ñ– Ñ†Ð¸Ñ„Ñ€Ð¸
          CLEAN_VERSION=$(echo "${FINAL_VERSION}" | sed 's/^v//')
          
          find . -type f -name "*.toc" | while read toc_file; do
            echo "ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð²ÐµÑ€ÑÑ–Ñ— Ð² Ñ„Ð°Ð¹Ð»Ñ–: $toc_file Ð´Ð¾ $CLEAN_VERSION"
            sed -i "s/^## Version: .*/## Version: ${CLEAN_VERSION}/" "$toc_file"
          done

      # Ð“ÐµÐ½ÐµÑ€ÑƒÑ”Ð¼Ð¾ changelog (Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±ÐµÐ½ Ñ„Ð°Ð¹Ð» cliff.toml Ñƒ ÐºÐ¾Ñ€ÐµÐ½Ñ–)
      - name: Generate CHANGELOG.md
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --latest --strip header --output CHANGELOG.md

      - name: Verify Changelog
        run: cat CHANGELOG.md || echo "Changelog not generated"

      # ÐŸÐ°ÐºÑƒÐ²Ð°Ð½Ð½Ñ Ñ‚Ð° Ð²Ñ–Ð´Ð¿Ñ€Ð°Ð²ÐºÐ° Ð½Ð° CurseForge / GitHub Releases
      - name: Create and Upload Package
        uses: BigWigsMods/packager@v2
        env:
          CF_API_KEY: ${{ secrets.CF_API_KEY }}  # Ð¢Ð¾ÐºÐµÐ½ CurseForge
          GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }} # Ð¢Ð¾ÐºÐµÐ½ GitHub (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¸Ð¹)

      - name: Add Summary
        run: |
          echo "## âœ… CI Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾ Ð´Ð»Ñ Ð²ÐµÑ€ÑÑ–Ñ— $FINAL_VERSION" >> $GITHUB_STEP_SUMMARY